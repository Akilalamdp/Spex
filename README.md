# Spex S1

Spex S2 is stage 2 of extracting information from the NVMe Working group
specification docx (Microsoft Word) files.

For information about stage 1, see the [[Spex S1|https://github.sec.samsung.net/DS8-MemoryOpenSource/spex-s1]] project.

Stage 2 operates on HTML documents generated by Spex-S1 from the docx
specification files.

Spex-S2 (stage 2) parses these HTML files with the goal of emitting
a subset of their information as normalized JSON objects.
Specifically, stage 2 tries to identify and parse two broad sets of figures:
1) Value figures (~enums)
2) Struct (Bits/Bytes) figures (~structs)

Value figures are tables which define a set of codes or values and assigns
them an associated description. These translate into enums in C.

Struct/bits/bytes figures define data-structures with multiple fields, where
each field has a concrete size and offset within the structure. These
translate into structs and bitfields (or fields and bit-shifting macros) in C.

The output of stage 2 is therefore a series of JSON objects, each object
corresponding to a figure and which is either of the value table- or struct
table type.

To get this output, stage 2 must normalize the input. This means that while most
tables can be extracted and parsed in a standardized fashion, some tables
require specific tweaks, such as skipping '...'/'notes' rows, extracing field
names from a different column and so on.

# Design (and design goals)

1) Every figure should have a unique ID
  * We generate unique IDs for nested tables
2) Every document is uniquely identified by its specification name and revision
3) For every figure, it must be possible to override how data is extracted
4) For every field in every figure, it must be possible to override the
   brief (~short comment on what the field is for) and label.

The specification documents are expressed in Microsoft Word (docx). This means
that variations in the format exist. Most tables' field names are part of the
textual description in the first column, but some tables have a separate column
for this. For other tables, the description provides no short-hand for the field
name, and so this must be inferred. For a few fields, no description exists at
all, requiring us to enrich the model by providing a label to use for that field.

For these reasons, one can inherit from the base `DocumentParser`, override
field names and briefs (short doc-strings), or override how a given figure is
processed.
For each figure, the Spex-S2 tries to determine if the figure is a Value table
or a Struct table, skipping it if it is neither.
There are default `FigureExtractors` for either case, but it is possible to
override this and provide a unique extractor for a given table. The extractor
classes have multiple methods which can be overridden to e.g. parse labels from
a different column or similar.

In order to permit overriding the label or brief of a field, or indeed to
override how a given figure is processed, it is imperative that each table
(and field) can be uniquely identified.
This is why each figure must have a unique ID (the X in 'Figure X: ...'). Nested
tables are assigned a name based on the figure ID of their parent table and the
value/(bit|byte) offset of the field.

# Status
This component is still in a relatively rough state.

Parsing (in the general) works, and the mechanisms for overriding how documents-
figures and individual fields are processed as mentioned above are in place.

However, the implementation is still being refined as further edge-cases are
being discovered.

To use it, place one or more HTML files to process in `docs/` and run `gcgen`
from the command-line.

In the future, reliance on gcgen for this component will be removed and replaced
by minimal CLI front-end using the standard `argparse` package.